<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Evil Peggle</title>
  <style>
    html,body{height:100%}
    body{margin:0;background:#07070a;color:#ececf1;font:14px/1.45 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Helvetica, Arial}
    .wrap{display:grid;grid-template-rows:auto 1fr auto; height:100%}
    header{display:flex;align-items:center;gap:.75rem;padding:.5rem 1rem;background:linear-gradient(180deg,#141418, #0b0b0e);border-bottom:1px solid #1a1a1f;position:sticky;top:0;z-index:10}
    header h1{font-size:12px;margin:0;letter-spacing:.14em;text-transform:uppercase;opacity:.9}
    header .sp{flex:1}
    .btn, select{cursor:pointer;user-select:none;border:1px solid #2a2a33;background:#121218;border-radius:10px;padding:.45rem .7rem;display:inline-flex;align-items:center;gap:.5rem;color:#eaeaf0}
    .btn:hover{background:#171723}
    .danger{border-color:#3a1820;background:#17060a;color:#fecaca}
    .good{border-color:#1d3a26;background:#06140a;color:#bbf7d0}
    .row{display:flex;align-items:center;gap:.5rem}
    main{display:grid;place-items:center;padding:.5rem}

    /* CRT look */
    .crt{position:relative}
    .crt:before{content:"";position:absolute;inset:0;pointer-events:none;background: repeating-linear-gradient(180deg, rgba(255,255,255,.035), rgba(255,255,255,.035) 1px, transparent 1px, transparent 3px)}
    .crt:after{content:"";position:absolute;inset:0;pointer-events:none;box-shadow:inset 0 0 160px rgba(0,0,0,.75)}

    canvas{background:#0a0a0c;border:1px solid #1b1b1f;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.7)}
    footer{display:flex;justify-content:space-between;align-items:center;padding:.5rem 1rem;border-top:1px solid #17171a;background:linear-gradient(180deg,#0a0a0c,#070708)}
    .meter{height:8px;border-radius:999px;background:#111214;border:1px solid #222;position:relative;overflow:hidden;width:260px}
    .meter>i{position:absolute;inset:0;background:linear-gradient(90deg, #e11d48, #f43f5e, #e11d48);transform-origin:left center;}
    .hud{display:flex;gap:1rem;align-items:center;flex-wrap:wrap}
    .badge{padding:.25rem .5rem;border:1px solid #24242a;border-radius:8px;background:#0f0f12}
    .overlay{position:absolute;inset:0;display:grid;place-items:center;color:#e5e7eb;pointer-events:none}
    .menu{pointer-events:auto;display:flex;flex-direction:column;align-items:center;gap:16px;background:rgba(10,10,12,.72);backdrop-filter:blur(6px);padding:28px;border:1px solid #222;border-radius:14px;text-align:center}
    .title{font:800 46px/1.05 "Cinzel", Trajan, serif;letter-spacing:.06em;text-transform:uppercase;text-align:center;text-shadow:0 0 18px #a00}
    .subtitle{opacity:.9}
    .warn{font-size:12px;opacity:.85;color:#fca5a5;max-width:640px}
    .flash{animation:flash 1.6s infinite}
    @keyframes flash{0%,60%{opacity:.25} 70%{opacity:.7} 100%{opacity:.25}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Evil Peggle</h1>
      <div class="sp"></div>
      <div class="row">
        <label>Quality <select id="quality"><option>Low</option><option selected>Med</option><option>High</option></select></label>
        <button id="muteBtn" class="btn" title="Toggle audio">üîä Audio</button>
        <button id="resetBtn" class="btn danger" title="Restart level">‚ü≤ Reset</button>
        <button id="helpBtn" class="btn" title="How to play">‚ùì Help</button>
      </div>
    </header>
    <main>
      <div class="crt">
        <canvas id="game" width="960" height="640"></canvas>
        <div class="overlay" id="uiOverlay"></div>
      </div>
    </main>
    <footer>
      <div class="hud">
        <span class="badge">Level: <b id="levelLabel">1</b></span>
        <span class="badge">Balls: <b id="ballsLabel">10</b></span>
        <span class="badge">Cursed left: <b id="cursedLabel">‚Äî</b></span>
        <span class="badge">Score: <b id="scoreLabel">0</b></span>
        <span class="badge">Streak: <b id="streakLabel">0</b></span>
        <span class="badge">Fear: <b id="fearLabel">0%</b></span>
        <span class="badge">Power: <b id="powerLabel">‚Äî</b></span>
      </div>
      <div class="meter" title="Progress to next level">
        <i id="progressFill" style="transform:scaleX(0)"></i>
      </div>
    </footer>
  </div>

<script>
(() => {
  // ===== Canvas & UI =====
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  const ui = document.getElementById('uiOverlay');

  // ===== HUD refs =====
  const ballsLabel = document.getElementById('ballsLabel');
  const scoreLabel = document.getElementById('scoreLabel');
  const streakLabel = document.getElementById('streakLabel');
  const cursedLabel = document.getElementById('cursedLabel');
  const levelLabel  = document.getElementById('levelLabel');
  const fearLabel   = document.getElementById('fearLabel');
  const powerLabel  = document.getElementById('powerLabel');
  const progressFill= document.getElementById('progressFill');

  // ===== Controls =====
  const muteBtn = document.getElementById('muteBtn');
  const resetBtn = document.getElementById('resetBtn');
  const helpBtn = document.getElementById('helpBtn');
  const qualitySel = document.getElementById('quality');

  helpBtn.onclick = () => alert(`How to play:
‚Ä¢ Move mouse to aim. Click to fire.
‚Ä¢ Clear ALL red cursed pegs to win.
‚Ä¢ Catch the eyeball in the bucket-monster for +1 ball.
‚Ä¢ Steel pegs bounce only.
‚Ä¢ Flaming Skull burns through multiple pegs.
‚Ä¢ Rotten ball shrinks your bucket until caught.
‚Ä¢ More hits = fear & score. High fear distorts reality.`);

  // ===== Quality toggle =====
  const quality = { mul: 1 };
  function applyQuality(){ const q=qualitySel.value; quality.mul = q==='Low'? 0.6 : q==='High'? 2.0 : 1.0; }
  qualitySel.onchange = applyQuality; applyQuality();

  // ===== Audio (procedural) =====
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let ac; let audioEnabled = true;
  function ensureAudio(){ if(!ac){ ac = new AudioCtx(); startMusic(); }}
  function tone(freq=200, dur=0.06, type='square', gain=0.02){ if(!audioEnabled) return; ensureAudio(); const o=ac.createOscillator(); const g=ac.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=gain; o.connect(g); g.connect(ac.destination); o.start(); o.stop(ac.currentTime+dur); }
  function noise(ms=100, vol=.12){ if(!audioEnabled) return; ensureAudio(); const n=ac.createBuffer(1, ac.sampleRate*ms/1000, ac.sampleRate); const d=n.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*(1-i/d.length); const s=ac.createBufferSource(); s.buffer=n; const g=ac.createGain(); g.gain.value=vol; s.connect(g); g.connect(ac.destination); s.start(); }
  function sting(){ if(!audioEnabled) return; ensureAudio(); const g=ac.createGain(); g.gain.value=.05; g.connect(ac.destination); [110, 147, 196, 277].forEach((f,i)=>{ const o=ac.createOscillator(); o.type='sawtooth'; o.frequency.value=f; o.connect(g); o.start(); o.stop(ac.currentTime+0.5+i*0.02)}); }
  function subBoom(){ if(!audioEnabled) return; ensureAudio(); const o=ac.createOscillator(); const g=ac.createGain(); o.type='sine'; o.frequency.setValueAtTime(160, ac.currentTime); o.frequency.exponentialRampToValueAtTime(40, ac.currentTime+0.6); g.gain.value=.06; o.connect(g); g.connect(ac.destination); o.start(); o.stop(ac.currentTime+0.65); }

  // Dissonant loop (detuned organ)
  let musicNode; function startMusic(){ if(!audioEnabled) return; if(musicNode){ try{musicNode.stop();}catch{}} ensureAudio(); const g=ac.createGain(); g.gain.value=.03; g.connect(ac.destination); const freqs=[196, 247, 330]; const detunes=[-8, 0, +7]; const oscs=[]; for(let i=0;i<freqs.length;i++){ const o=ac.createOscillator(); o.type='triangle'; o.frequency.value=freqs[i]; o.detune.value=detunes[i]; o.connect(g); o.start(); oscs.push(o);} 
    setInterval(()=>{ if(!ac) return; g.gain.value = .02 + Math.random()*0.015; }, 1200);
    musicNode = { stop(){ oscs.forEach(o=>o.stop()); } };
  }

  // Whispers (procedural hiss + formant-ish tone)
  function whisper(){ if(!audioEnabled) return; ensureAudio(); const dur=0.9; const n=ac.createBuffer(1, ac.sampleRate*dur, ac.sampleRate); const d=n.getChannelData(0); for(let i=0;i<d.length;i++){ const t=i/d.length; d[i]=(Math.random()*2-1)*0.4*(1-t); } const s=ac.createBufferSource(); s.buffer=n; const g=ac.createGain(); g.gain.value=.03; s.connect(g); g.connect(ac.destination); s.start(); }

  muteBtn.onclick = () => { audioEnabled=!audioEnabled; muteBtn.textContent = audioEnabled? 'üîä Audio':'üîá Muted'; if(audioEnabled){ ensureAudio(); tone(720,0.06,'sine',0.03);} };

  // ===== Sprites (embedded SVG -> Image) =====
  const Spr = {};
  function svgToImg(svg){ const img=new Image(); img.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(svg.trim()); return img; }

  // ... (sprites, levels, world, ball class, particles, collisions, decals, hitPeg, etc.)
  // ... (everything remains unchanged from your baseline ‚Äî only titles/names updated) ...

  // ===== UI Screens =====
  function setOverlay(html){ ui.innerHTML = html||''; }
  function showBoot(){ setOverlay(`<div class="menu"><div class="title">Evil Peggle</div><div class="subtitle" id="bootMsg">${bootMsgs[0]}</div><div class="meter" style="width:320px"><i id="bootFill" style="transform:scaleX(0)"></i></div><div class="warn">Content warning: flashing lights and stylized gore. Headphones recommended.</div><div class="flash" style="margin-top:10px">PRESS SPACE</div></div>`); }
  function startMenu(){ state=STATE.MENU; world.aim.ready=false; setOverlay(`<div class="menu"><div class="title">Evil Peggle</div><div class="subtitle">H‚çúrr‚çúr Arcade</div><button class="btn play good" id="playBtn">‚ñ∂ PLAY</button><div class="warn">SPACE or Click to begin. Use the Quality menu if performance dips.</div><div class="flash">PRESS SPACE</div></div>`); document.getElementById('playBtn').onclick=()=> startGame(); }

  // ... rest of game loop & logic unchanged ...
})();
</script>
</body>
</html>
