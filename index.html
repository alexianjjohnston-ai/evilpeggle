<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Evil Peggle</title>
  <style>
    html,body{height:100%}
    body{margin:0;background:#07070a;color:#ececf1;font:14px/1.45 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Helvetica, Arial}
    .wrap{display:grid;grid-template-rows:auto 1fr auto;height:100%}
    .masthead{display:flex;flex-wrap:wrap;align-items:flex-start;gap:1rem;padding:.85rem 1.2rem;background:linear-gradient(180deg,#191720,#08070c);border-bottom:1px solid #211f29;box-shadow:0 10px 30px rgba(0,0,0,.45);position:sticky;top:0;z-index:12}
    .masthead h1{font-size:12px;margin:0;letter-spacing:.18em;text-transform:uppercase;opacity:.92}
    .tagline{margin:0;font-size:11px;letter-spacing:.22em;text-transform:uppercase;color:#d946ef;opacity:.65}
    .masthead .sp{flex:1 0 40px}
    .row{display:flex;align-items:center;gap:.65rem;flex-wrap:wrap;justify-content:flex-end}
    .btn, select{cursor:pointer;user-select:none;border:1px solid rgba(220,64,120,.45);background:linear-gradient(180deg,rgba(52,8,24,.9),rgba(18,8,24,.9));border-radius:12px;padding:.52rem .85rem;display:inline-flex;align-items:center;gap:.5rem;color:#f9d9f3;font-weight:600;letter-spacing:.04em;text-transform:uppercase;font-size:11px;box-shadow:0 6px 14px rgba(220,64,120,.18), inset 0 0 0 1px rgba(255,255,255,.04)}
    .btn:hover{filter:brightness(1.12)}
    .btn.ghost{border-color:rgba(88,76,140,.45);background:linear-gradient(180deg,rgba(24,22,36,.9),rgba(16,14,26,.92));color:#cbd5ff}
    .btn.ghost:hover{filter:brightness(1.05)}
    .danger{border-color:#54111f;background:linear-gradient(180deg,rgba(90,16,32,.85),rgba(40,6,12,.95));color:#fecaca}
    .good{border-color:#115420;background:linear-gradient(180deg,rgba(16,90,48,.85),rgba(6,32,18,.95));color:#bbf7d0}
    main{display:flex;align-items:stretch;justify-content:center;gap:1.5rem;padding:1rem;flex-wrap:wrap}
    .center-col{flex:1 1 520px;display:flex;flex-direction:column;align-items:center;gap:1.25rem;min-width:320px;max-width:960px;width:100%}
    .hud-top{width:100%;display:flex;flex-direction:column;align-items:center;gap:.75rem;padding:0 1rem}

    /* CRT look */
    .crt{position:relative;display:flex;justify-content:center;width:100%}
    .crt:before{content:"";position:absolute;inset:0;pointer-events:none;background: repeating-linear-gradient(180deg, rgba(255,255,255,.035), rgba(255,255,255,.035) 1px, transparent 1px, transparent 3px)}
    .crt:after{content:"";position:absolute;inset:0;pointer-events:none;box-shadow:inset 0 0 160px rgba(0,0,0,.75)}

    canvas{background:#0a0a0c;border:1px solid #1b1b1f;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.7);width:min(100%,960px);height:auto}
    footer{display:flex;justify-content:center;align-items:center;gap:1rem;padding:.75rem 1rem;border-top:1px solid #17171a;background:linear-gradient(180deg,#0a0a0c,#070708)}
    .title-group{display:flex;flex-direction:column;gap:.35rem;min-width:220px}
    .fear-bar{display:flex;align-items:center;justify-content:center;gap:.65rem;font-size:11px;letter-spacing:.12em;text-transform:uppercase;opacity:.9;flex-wrap:wrap}
    .fear-bar .label{opacity:.7}
    #fearLabel{font-weight:600;letter-spacing:.08em}
    .meter{height:9px;border-radius:999px;background:linear-gradient(180deg,#0a0b10,#14071a);border:1px solid rgba(255,80,120,.4);position:relative;overflow:hidden;box-shadow:0 8px 18px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.06)}
    .meter>i{position:absolute;inset:0;background:linear-gradient(90deg,#22d3ee,#f43f5e,#ec4899);transform-origin:left center;transition:transform .25s cubic-bezier(.33,1,.68,1)}
    .meter.fear{width:100%;max-width:420px;height:14px}
    .meter.progress{width:320px;margin:0 auto}
    .sidebar{display:flex;flex-direction:column;gap:1rem;min-width:180px}
    .sidebar.right{align-items:flex-start;justify-content:flex-start}
    .stat-card{position:relative;padding:1.05rem 1rem;border-radius:18px;background:linear-gradient(180deg,rgba(28,15,24,.92),rgba(12,6,14,.95));border:1px solid rgba(255,80,140,.32);box-shadow:0 14px 32px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.04);display:flex;flex-direction:column;gap:.45rem;text-transform:uppercase;overflow:hidden;min-width:160px}
    .stat-card:before{content:"";position:absolute;inset:0;pointer-events:none;background:radial-gradient(circle at 20% -30%,rgba(255,80,140,.35),transparent 55%)}
    .stat-title{font-size:11px;letter-spacing:.26em;opacity:.7;color:#fbb6d4}
    .stat-value{font-size:28px;font-weight:800;letter-spacing:.08em;color:#fff0f6;text-shadow:0 3px 12px rgba(255,64,128,.35)}
    .stat-card[data-tone="void"]{border-color:rgba(124,58,237,.32)}
    .stat-card[data-tone="void"]:before{background:radial-gradient(circle at 18% -40%,rgba(124,58,237,.38),transparent 55%)}
    .stat-card[data-tone="fang"]{border-color:rgba(248,113,113,.42)}
    .stat-card[data-tone="score"]{border-color:rgba(250,204,21,.38)}
    .power-slot{width:100%;max-width:420px;margin-top:.4rem;display:flex;align-items:center;gap:.85rem;padding:.85rem 1rem;border-radius:18px;background:linear-gradient(180deg,rgba(18,10,20,.9),rgba(8,4,12,.95));border:1px solid rgba(124,58,237,.35);box-shadow:0 12px 28px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.04)}
    .power-slot.power-empty{border-color:rgba(88,76,140,.32);opacity:.82}
    .power-icon{width:56px;height:56px;border-radius:16px;background:rgba(12,6,16,.8);border:1px solid rgba(124,58,237,.45);box-shadow:inset 0 0 0 1px rgba(255,255,255,.06);object-fit:contain;image-rendering:crisp-edges;filter:drop-shadow(0 4px 12px rgba(124,58,237,.35))}
    .power-copy{display:flex;flex-direction:column;gap:.25rem}
    .power-name{font-size:13px;letter-spacing:.18em;text-transform:uppercase;color:#ede9fe}
    .power-desc{font-size:11px;letter-spacing:.05em;color:rgba(206,198,255,.78)}
    .poster-card{position:relative;padding:1.2rem 1.1rem;border-radius:20px;background:radial-gradient(circle at top,#1d101f 0%,#0b060c 65%);border:1px solid rgba(148,163,184,.25);color:#e9e0ff;max-width:240px;box-shadow:0 18px 36px rgba(0,0,0,.5), inset 0 0 0 1px rgba(255,255,255,.04);line-height:1.45}
    .poster-title{text-transform:uppercase;letter-spacing:.28em;font-size:12px;margin-bottom:.65rem;color:#fda4af}
    .poster-chain{margin-top:1.3rem;height:6px;width:100%;background:repeating-linear-gradient(90deg,rgba(255,255,255,.35) 0 12px,rgba(0,0,0,0) 12px 16px);opacity:.35}
    .settings-overlay{position:fixed;inset:0;background:rgba(8,6,12,.65);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;padding:2rem;z-index:40}
    .settings-overlay.hidden{display:none}
    .settings-panel{background:linear-gradient(180deg,rgba(26,16,32,.96),rgba(14,8,20,.98));border-radius:22px;border:1px solid rgba(255,64,120,.38);box-shadow:0 22px 44px rgba(0,0,0,.6), inset 0 0 0 1px rgba(255,255,255,.06);max-width:420px;width:100%;padding:1.8rem}
    .settings-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.25rem}
    .settings-head h2{margin:0;font-size:22px;letter-spacing:.12em;text-transform:uppercase;color:#f9a8d4}
    .settings-body{display:flex;flex-direction:column;gap:1rem}
    .setting-row{display:flex;align-items:center;justify-content:space-between;gap:1rem;background:rgba(16,10,18,.8);border-radius:14px;padding:.8rem 1rem;border:1px solid rgba(255,255,255,.06);color:#f4d4ff;font-size:13px;letter-spacing:.06em;text-transform:uppercase}
    .setting-row select{flex:0 0 140px;border-radius:10px;border:1px solid rgba(255,64,160,.4);background:rgba(30,18,36,.92);color:#fef2ff;font-weight:600}
    .setting-row.toggle{justify-content:flex-start;gap:.75rem}
    .setting-row.toggle span{flex:1}
    .setting-row input[type="checkbox"]{width:18px;height:18px;border-radius:4px;border:1px solid rgba(255,64,160,.5);background:#130915;accent-color:#f43f5e}
    .settings-note{margin:0;margin-top:.3rem;font-size:11px;letter-spacing:.08em;text-transform:uppercase;color:rgba(244,194,255,.65)}
    select{appearance:none;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 6"><path fill="%23f9d9f3" d="M0 0h10L5 6z"/></svg>');background-repeat:no-repeat;background-position:right .6rem center;background-size:10px 6px;padding-right:2rem}
    .overlay{position:absolute;inset:0;display:grid;place-items:center;color:#e5e7eb;pointer-events:none}
    .streak-pop{position:absolute;font:700 24px/1 Inter, ui-sans-serif, system-ui;color:#f87171;text-shadow:0 0 12px rgba(248,113,113,.6);pointer-events:none}
    .menu{pointer-events:auto;display:flex;flex-direction:column;align-items:center;gap:16px;background:rgba(10,10,12,.72);backdrop-filter:blur(6px);padding:28px;border:1px solid #222;border-radius:14px;text-align:center}
    .title{font:800 46px/1.05 "Cinzel", Trajan, serif;letter-spacing:.06em;text-transform:uppercase;text-align:center;text-shadow:0 0 18px #a00}
    .subtitle{opacity:.9}
    .warn{font-size:12px;opacity:.85;color:#fca5a5;max-width:640px}
    @media (max-width:1100px){
      main{flex-direction:column;gap:1.5rem;align-items:stretch}
      .center-col{order:1;min-width:0}
      .sidebar{flex-direction:row;align-items:center;justify-content:center;flex-wrap:wrap;width:100%;order:2}
      .sidebar.right{order:3;align-items:center}
      .stat-card{min-width:150px;text-align:center}
      .poster-card{max-width:320px}
      .masthead{align-items:center;justify-content:center}
    }
    @media (max-width:700px){
      .sidebar{gap:.65rem}
      .stat-card{flex:1 1 150px}
      .hud-top{padding:0}
      .meter.progress{width:100%}
    }
    @media (max-width:520px){
      .masthead{justify-content:center}
      .masthead .row{justify-content:center;width:100%}
      canvas{width:100%}
    }
    .flash{animation:flash 1.6s infinite}
    @keyframes flash{0%,60%{opacity:.25} 70%{opacity:.7} 100%{opacity:.25}}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="masthead">
      <div class="title-group">
        <h1>Evil Peggle</h1>
        <p class="tagline">Sling souls into the maw</p>
      </div>
      <div class="sp"></div>
      <div class="row">
        <button id="settingsBtn" class="btn ghost" title="Game options">‚öô Settings</button>
        <button id="muteBtn" class="btn" title="Toggle audio">üîä Audio</button>
        <button id="resetBtn" class="btn danger" title="Restart level">‚ü≤ Reset</button>
        <button id="helpBtn" class="btn" title="How to play">‚ùì Help</button>
      </div>
    </header>
    <main>
      <aside class="sidebar left">
        <div class="stat-card" data-tone="void">
          <span class="stat-title">Level</span>
          <span class="stat-value" id="levelLabel">1</span>
        </div>
        <div class="stat-card" data-tone="fang">
          <span class="stat-title">Shots</span>
          <span class="stat-value" id="ballsLabel">10</span>
        </div>
        <div class="stat-card" data-tone="score">
          <span class="stat-title">Score</span>
          <span class="stat-value" id="scoreLabel">0</span>
        </div>
      </aside>
      <section class="center-col">
        <div class="hud-top">
          <div class="fear-bar">
            <span class="label">Fear</span>
            <div class="meter fear" title="Current terror level">
              <i id="fearFill" style="transform:scaleX(0)"></i>
            </div>
            <span id="fearLabel">0%</span>
          </div>
          <div class="power-slot power-empty" id="powerSlot">
            <img id="powerIcon" class="power-icon" alt="Relic icon" src="" />
            <div class="power-copy">
              <span class="power-name" id="powerName">No Relic</span>
              <span class="power-desc" id="powerDesc">Break cursed pegs to uncover infernal relics.</span>
            </div>
          </div>
        </div>
        <div class="crt">
          <canvas id="game" width="960" height="640"></canvas>
          <div class="overlay" id="uiOverlay"></div>
        </div>
      </section>
      <aside class="sidebar right">
        <div class="poster-card">
          <div class="poster-title">Feed The Pit</div>
          <p>Fell the cursed pegs to fatten the horror below. Survive the rituals to unlock darker arenas.</p>
          <div class="poster-chain"></div>
        </div>
      </aside>
    </main>
    <div id="settingsOverlay" class="settings-overlay hidden">
      <div class="settings-panel">
        <div class="settings-head">
          <h2>Den Settings</h2>
          <button id="settingsClose" class="btn ghost" type="button">‚úï Close</button>
        </div>
        <div class="settings-body">
          <label class="setting-row">Quality
            <select id="quality">
              <option value="Low">Low</option>
              <option value="Med" selected>Med</option>
              <option value="High">High</option>
            </select>
          </label>
          <label class="setting-row toggle">
            <input type="checkbox" id="shakeToggle" checked />
            <span>Screen shake</span>
          </label>
          <label class="setting-row toggle">
            <input type="checkbox" id="visionsToggle" checked />
            <span>Hallucination FX</span>
          </label>
          <p class="settings-note">Need quiet? Toggle audio anytime from the header.</p>
        </div>
      </div>
    </div>
    <footer>
      <div class="meter progress" title="Progress to next level">
        <i id="progressFill" style="transform:scaleX(0)"></i>
      </div>
    </footer>
  </div>

<script>
(() => {
  // ===== Canvas & UI =====
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  const ui = document.getElementById('uiOverlay');

  // ===== HUD refs =====
  const ballsLabel = document.getElementById('ballsLabel');
  const scoreLabel = document.getElementById('scoreLabel');
  const levelLabel  = document.getElementById('levelLabel');
  const fearLabel   = document.getElementById('fearLabel');
  const fearFill    = document.getElementById('fearFill');
  const progressFill= document.getElementById('progressFill');
  const powerIcon   = document.getElementById('powerIcon');
  const powerName   = document.getElementById('powerName');
  const powerDesc   = document.getElementById('powerDesc');
  const powerSlot   = document.getElementById('powerSlot');

  const settingsOverlay = document.getElementById('settingsOverlay');
  const settingsBtn = document.getElementById('settingsBtn');
  const settingsClose = document.getElementById('settingsClose');
  const shakeToggle = document.getElementById('shakeToggle');
  const visionsToggle = document.getElementById('visionsToggle');

  // ===== Controls =====
  const muteBtn = document.getElementById('muteBtn');
  const resetBtn = document.getElementById('resetBtn');
  const helpBtn = document.getElementById('helpBtn');
  const qualitySel = document.getElementById('quality');

  helpBtn.onclick = () => alert(`How to play:
‚Ä¢ Move mouse to aim. Click to fire.
‚Ä¢ Clear ALL cursed pegs to advance.
‚Ä¢ Feed the trap maw for bonus shots and streak boosts.
‚Ä¢ Steel pegs only ricochet unless melted by Ghoul Ichor.
‚Ä¢ Relics: Reaper Fang pierces foes; Ghoul Ichor corrupts nearby pegs.
‚Ä¢ Longer streaks ramp fear ‚Äî high fear spawns hallucinations. Tune FX in Settings.`);

  const fxSettings = {
    shake: shakeToggle ? shakeToggle.checked : true,
    visions: visionsToggle ? visionsToggle.checked : true,
  };

  function openSettings(){ if(settingsOverlay){ settingsOverlay.classList.remove('hidden'); } }
  function closeSettings(){ if(settingsOverlay){ settingsOverlay.classList.add('hidden'); } }

  settingsBtn?.addEventListener('click', ()=> openSettings());
  settingsClose?.addEventListener('click', ()=> closeSettings());
  settingsOverlay?.addEventListener('click', (e)=>{ if(e.target===settingsOverlay) closeSettings(); });
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && !settingsOverlay?.classList.contains('hidden')) closeSettings(); });
  shakeToggle?.addEventListener('change', ()=>{
    fxSettings.shake = !!shakeToggle.checked;
    if(!fxSettings.shake) world.screenShake = 0;
  });
  visionsToggle?.addEventListener('change', ()=>{
    fxSettings.visions = !!visionsToggle.checked;
    if(!fxSettings.visions) world.hallucinations = [];
  });

  // ===== Quality toggle =====
  const quality = { mul: 1 };
  function applyQuality(){ const q=qualitySel?.value || 'Med'; quality.mul = q==='Low'? 0.6 : q==='High'? 2.0 : 1.0; }
  if(qualitySel){ qualitySel.onchange = applyQuality; }
  applyQuality();

  // ===== Audio (procedural) =====
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let ac;
  let audioEnabled = true;
  let musicNode = null;
  let musicPulse = null;

  function ensureAudio(){
    if(!AudioCtx) return null;
    if(!ac){
      ac = new AudioCtx();
    }
    if(audioEnabled && ac && ac.state === 'suspended'){
      ac.resume();
    }
    return ac;
  }

  function stopMusic(){
    if(musicNode){
      try{ musicNode.stop(); } catch {}
      musicNode = null;
    }
    if(musicPulse){
      clearInterval(musicPulse);
      musicPulse = null;
    }
  }

  function startMusic(){
    if(!audioEnabled) return;
    ensureAudio();
    if(!ac) return;
    stopMusic();
    const g = ac.createGain();
    g.gain.value = .03;
    g.connect(ac.destination);
    const freqs = [196, 247, 330];
    const detunes = [-8, 0, +7];
    const oscs = [];
    for(let i=0;i<freqs.length;i++){
      const o = ac.createOscillator();
      o.type = 'triangle';
      o.frequency.value = freqs[i];
      o.detune.value = detunes[i];
      o.connect(g);
      o.start();
      oscs.push(o);
    }
    musicPulse = setInterval(()=>{
      if(!audioEnabled || !ac) return;
      g.gain.value = .02 + Math.random()*0.015;
    }, 1200);
    musicNode = {
      stop(){
        oscs.forEach(o=>{
          try{o.stop();}catch{}
        });
        g.disconnect();
      }
    };
  }

  function armMusic(){
    if(audioEnabled && !musicNode){
      startMusic();
    }
  }

  function tone(freq=200, dur=0.06, type='square', gain=0.02){
    if(!audioEnabled) return;
    ensureAudio();
    if(!ac) return;
    const o=ac.createOscillator();
    const g=ac.createGain();
    o.type=type;
    o.frequency.value=freq;
    g.gain.value=gain;
    o.connect(g);
    g.connect(ac.destination);
    o.start();
    o.stop(ac.currentTime+dur);
    armMusic();
  }

  function noise(ms=100, vol=.12){
    if(!audioEnabled) return;
    ensureAudio();
    if(!ac) return;
    const n=ac.createBuffer(1, ac.sampleRate*ms/1000, ac.sampleRate);
    const d=n.getChannelData(0);
    for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*(1-i/d.length);
    const s=ac.createBufferSource();
    s.buffer=n;
    const g=ac.createGain();
    g.gain.value=vol;
    s.connect(g);
    g.connect(ac.destination);
    s.start();
    armMusic();
  }

  function sting(){
    if(!audioEnabled) return;
    ensureAudio();
    if(!ac) return;
    const g=ac.createGain();
    g.gain.value=.05;
    g.connect(ac.destination);
    [110,147,196,277].forEach((f,i)=>{
      const o=ac.createOscillator();
      o.type='sawtooth';
      o.frequency.value=f;
      o.connect(g);
      o.start();
      o.stop(ac.currentTime+0.5+i*0.02);
    });
    armMusic();
  }

  function subBoom(){
    if(!audioEnabled) return;
    ensureAudio();
    if(!ac) return;
    const o=ac.createOscillator();
    const g=ac.createGain();
    o.type='sine';
    o.frequency.setValueAtTime(160, ac.currentTime);
    o.frequency.exponentialRampToValueAtTime(40, ac.currentTime+0.6);
    g.gain.value=.06;
    o.connect(g);
    g.connect(ac.destination);
    o.start();
    o.stop(ac.currentTime+0.65);
    armMusic();
  }

  // Whispers (procedural hiss + formant-ish tone)
  function whisper(){
    if(!audioEnabled) return;
    ensureAudio();
    if(!ac) return;
    const dur=0.9;
    const n=ac.createBuffer(1, ac.sampleRate*dur, ac.sampleRate);
    const d=n.getChannelData(0);
    for(let i=0;i<d.length;i++){
      const t=i/d.length;
      d[i]=(Math.random()*2-1)*0.4*(1-t);
    }
    const s=ac.createBufferSource();
    s.buffer=n;
    const g=ac.createGain();
    g.gain.value=.03;
    s.connect(g);
    g.connect(ac.destination);
    s.start();
    armMusic();
  }

  function setAudioEnabled(enabled){
    audioEnabled = enabled;
    muteBtn.textContent = audioEnabled ? 'üîä Audio' : 'üîá Muted';
    if(audioEnabled){
      ensureAudio();
      startMusic();
      tone(720,0.06,'sine',0.03);
    } else {
      stopMusic();
      if(ac && typeof ac.suspend==='function'){
        ac.suspend();
      }
    }
  }

  muteBtn.onclick = () => setAudioEnabled(!audioEnabled);

  // ===== Sprites (embedded SVG -> Image) =====
  const Spr = {};
  function svgToImg(svg){ const img=new Image(); img.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(svg.trim()); return img; }
  // Eyeball orb (default)
  Spr.ball = svgToImg(`
  <svg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 64 64'>
    <defs>
      <radialGradient id='eyeS' cx='50%' cy='44%' r='52%'>
        <stop offset='0%' stop-color='#fff9fb'/>
        <stop offset='55%' stop-color='#ede6ff'/>
        <stop offset='100%' stop-color='#c7b7df'/>
      </radialGradient>
      <radialGradient id='eyeI' cx='46%' cy='46%' r='40%'>
        <stop offset='0%' stop-color='#fdf4ff'/>
        <stop offset='55%' stop-color='#c084fc'/>
        <stop offset='100%' stop-color='#581c87'/>
      </radialGradient>
      <linearGradient id='eyeVein' x1='0' y1='0' x2='1' y2='1'>
        <stop offset='0%' stop-color='#f472b6' stop-opacity='.85'/>
        <stop offset='100%' stop-color='#8b5cf6' stop-opacity='.2'/>
      </linearGradient>
    </defs>
    <circle cx='32' cy='32' r='30' fill='url(#eyeS)' stroke='#40285c' stroke-width='2'/>
    <circle cx='31' cy='30' r='14.5' fill='url(#eyeI)'/>
    <circle cx='29.5' cy='29.5' r='7.4' fill='#0c0716'/>
    <circle cx='27.4' cy='27' r='3.8' fill='#fff' opacity='.55'/>
    <path d='M8 22 C15 18 24 14 32 17' stroke='url(#eyeVein)' stroke-width='2.8' stroke-linecap='round' fill='none'/>
    <path d='M12 42 C22 46 26 50 30 56' stroke='url(#eyeVein)' stroke-width='2.4' stroke-linecap='round' fill='none' opacity='.75'/>
    <path d='M56 26 C48 18 40 16 34 16' stroke='url(#eyeVein)' stroke-width='2.4' stroke-linecap='round' fill='none' opacity='.55'/>
  </svg>`);
  // Reaper Fang orb
  Spr.reaperBall = svgToImg(`
  <svg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 64 64'>
    <defs>
      <radialGradient id='reaperBody' cx='48%' cy='46%' r='50%'>
        <stop offset='0%' stop-color='#ffe4e6'/>
        <stop offset='55%' stop-color='#fb7185'/>
        <stop offset='100%' stop-color='#330714'/>
      </radialGradient>
      <linearGradient id='reaperBlade' x1='0' y1='0' x2='1' y2='1'>
        <stop offset='0%' stop-color='#fde68a'/>
        <stop offset='100%' stop-color='#f97316'/>
      </linearGradient>
      <radialGradient id='reaperCore' cx='38%' cy='32%' r='28%'>
        <stop offset='0%' stop-color='#fff'/>
        <stop offset='100%' stop-color='#dc2626'/>
      </radialGradient>
    </defs>
    <circle cx='32' cy='32' r='28' fill='url(#reaperBody)' stroke='#7f1d1d' stroke-width='2'/>
    <circle cx='30' cy='29' r='11' fill='url(#reaperCore)' opacity='.82'/>
    <path d='M12 18 C28 6 44 8 54 20' stroke='#fca5a5' stroke-width='4' stroke-linecap='round' opacity='.35'/>
    <path d='M18 44 C28 50 38 48 46 40' stroke='#fb7185' stroke-width='3' stroke-linecap='round' opacity='.4'/>
    <path d='M12 46 Q36 26 56 32' fill='none' stroke='url(#reaperBlade)' stroke-width='6' stroke-linecap='round' opacity='.92'/>
    <path d='M18 46 Q32 34 48 30 Q42 40 30 50 Z' fill='rgba(2,6,23,.45)'/>
  </svg>`);
  // Blight orb
  Spr.blightBall = svgToImg(`
  <svg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 64 64'>
    <defs>
      <radialGradient id='blightBody' cx='52%' cy='40%' r='52%'>
        <stop offset='0%' stop-color='#f0fdf4'/>
        <stop offset='55%' stop-color='#4ade80'/>
        <stop offset='100%' stop-color='#14532d'/>
      </radialGradient>
      <radialGradient id='blightCore' cx='38%' cy='30%' r='28%'>
        <stop offset='0%' stop-color='#ecfccb'/>
        <stop offset='100%' stop-color='#166534'/>
      </radialGradient>
    </defs>
    <circle cx='32' cy='32' r='29' fill='url(#blightBody)' stroke='#064e3b' stroke-width='2'/>
    <circle cx='29' cy='28' r='11' fill='url(#blightCore)' opacity='.85'/>
    <g fill='#bbf7d0' opacity='.7'>
      <circle cx='20' cy='24' r='3'/>
      <circle cx='40' cy='18' r='2.4'/>
      <circle cx='26' cy='46' r='4'/>
      <circle cx='44' cy='36' r='3.2'/>
    </g>
    <path d='M18 50 Q32 42 46 48' stroke='rgba(74,222,128,.45)' stroke-width='3' stroke-linecap='round' fill='none'/>
    <path d='M14 20 C20 12 32 10 40 14' stroke='rgba(22,101,52,.5)' stroke-width='3' stroke-linecap='round' fill='none'/>
  </svg>`);
  // Cursed face peg (two frames: open/closed mouth) ‚Äî untouched per lore
  Spr.cursedA = svgToImg(`<svg xmlns='http://www.w3.org/2000/svg' width='48' height='48' viewBox='0 0 48 48'><defs><radialGradient id='r' cx='50%' cy='40%' r='60%'><stop offset='0%' stop-color='#ff647c'/><stop offset='60%' stop-color='#d2122e'/><stop offset='100%' stop-color='#6b0814'/></radialGradient></defs><circle cx='24' cy='24' r='22' fill='url(#r)' stroke='#2b0007' stroke-width='2'/><ellipse cx='16' cy='20' rx='6' ry='5' fill='#1a0010'/><ellipse cx='32' cy='20' rx='6' ry='5' fill='#1a0010'/><path d='M12 30 Q24 38 36 30' stroke='#1a0010' stroke-width='4' fill='none'/></svg>`);
  Spr.cursedB = svgToImg(`<svg xmlns='http://www.w3.org/2000/svg' width='48' height='48' viewBox='0 0 48 48'><defs><radialGradient id='r' cx='50%' cy='40%' r='60%'><stop offset='0%' stop-color='#ff647c'/><stop offset='60%' stop-color='#d2122e'/><stop offset='100%' stop-color='#6b0814'/></radialGradient></defs><circle cx='24' cy='24' r='22' fill='url(#r)' stroke='#2b0007' stroke-width='2'/><ellipse cx='16' cy='20' rx='6' ry='5' fill='#1a0010'/><ellipse cx='32' cy='20' rx='6' ry='5' fill='#1a0010'/><path d='M12 30 Q24 28 36 30' stroke='#1a0010' stroke-width='5' fill='none'/></svg>`);
  // Normal gore peg reinvented as a flesh totem
  Spr.meat = svgToImg(`<svg xmlns='http://www.w3.org/2000/svg' width='44' height='44' viewBox='0 0 44 44'>
    <defs>
      <radialGradient id='flesh' cx='48%' cy='42%' r='58%'>
        <stop offset='0%' stop-color='#f8d4d4'/>
        <stop offset='60%' stop-color='#f87171'/>
        <stop offset='100%' stop-color='#7f1d1d'/>
      </radialGradient>
      <linearGradient id='scar' x1='0' y1='0' x2='0' y2='1'>
        <stop offset='0%' stop-color='#fecdd3' stop-opacity='.9'/>
        <stop offset='100%' stop-color='#be123c' stop-opacity='.2'/>
      </linearGradient>
    </defs>
    <path d='M8 10 Q22 2 36 10 L36 34 Q22 42 8 34 Z' fill='url(#flesh)' stroke='#601210' stroke-width='2' stroke-linejoin='round'/>
    <path d='M14 14 Q22 12 30 14' stroke='url(#scar)' stroke-width='2.4' fill='none'/>
    <path d='M12 24 Q22 20 32 24' stroke='url(#scar)' stroke-width='2' fill='none' opacity='.75'/>
    <circle cx='20' cy='30' r='3' fill='#450a0a' opacity='.65'/>
    <circle cx='26' cy='32' r='2.6' fill='#450a0a' opacity='.55'/>
  </svg>`);
  // Steel sentinel peg
  Spr.steel = svgToImg(`<svg xmlns='http://www.w3.org/2000/svg' width='44' height='44' viewBox='0 0 44 44'>
    <defs>
      <radialGradient id='steelBody' cx='40%' cy='40%' r='60%'>
        <stop offset='0%' stop-color='#f9fafb'/>
        <stop offset='55%' stop-color='#94a3b8'/>
        <stop offset='100%' stop-color='#1f2937'/>
      </radialGradient>
      <linearGradient id='steelRim' x1='0' y1='0' x2='1' y2='1'>
        <stop offset='0%' stop-color='#e2e8f0'/>
        <stop offset='100%' stop-color='#64748b'/>
      </linearGradient>
    </defs>
    <circle cx='22' cy='22' r='20' fill='url(#steelBody)' stroke='url(#steelRim)' stroke-width='2'/>
    <circle cx='22' cy='22' r='6.8' fill='#0f172a' opacity='.85'/>
    <path d='M10 14 L14 10 M30 8 L34 12 M36 30 L32 34 M12 34 L8 30' stroke='#475569' stroke-width='2' stroke-linecap='round' opacity='.6'/>
  </svg>`);
  // Blood splat sprite
  Spr.splat = svgToImg(`<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 64 64'><defs><radialGradient id='s' cx='48%' cy='42%' r='52%'><stop offset='0%' stop-color='#f87171'/><stop offset='80%' stop-color='#7f1d1d'/><stop offset='100%' stop-color='#450a0a'/></radialGradient></defs><path d='M30 6 C22 4 10 14 12 24 C6 28 4 34 8 40 C12 46 20 46 24 52 C28 58 34 60 40 58 C48 56 52 50 52 44 C58 40 58 32 54 26 C56 18 50 8 42 6 C38 4 34 4 30 6 Z' fill='url(#s)'/></svg>`);
  // Background wallpaper with flashy stripes
  Spr.bg = svgToImg(`<svg xmlns='http://www.w3.org/2000/svg' width='960' height='640' viewBox='0 0 960 640'>
    <defs>
      <linearGradient id='bgMain' x1='0' y1='0' x2='0' y2='1'>
        <stop offset='0%' stop-color='#160f1e'/>
        <stop offset='100%' stop-color='#06030a'/>
      </linearGradient>
      <linearGradient id='bgGlow' x1='0' y1='0' x2='1' y2='0'>
        <stop offset='0%' stop-color='rgba(244,63,94,0)'/>
        <stop offset='50%' stop-color='rgba(244,63,94,0.35)'/>
        <stop offset='100%' stop-color='rgba(67,56,202,0)'/>
      </linearGradient>
    </defs>
    <rect width='960' height='640' fill='url(#bgMain)'/>
    <g opacity='.16'>
      <path d='M-40 520 Q200 420 420 500 T960 480' stroke='url(#bgGlow)' stroke-width='90' fill='none'/>
      <path d='M-60 420 Q220 470 440 420 T980 440' stroke='rgba(248,113,113,0.35)' stroke-width='46' fill='none'/>
    </g>
    <g opacity='.12' stroke='rgba(203,213,225,0.15)' stroke-width='1'>
      <path d='M0 120 H960'/>
      <path d='M0 260 H960'/>
      <path d='M0 400 H960'/>
    </g>
  </svg>`);
  // Trap maw (open/closed)
  Spr.bucketOpen = svgToImg(`<svg xmlns='http://www.w3.org/2000/svg' width='160' height='54' viewBox='0 0 160 54'>
    <defs>
      <linearGradient id='pitBody' x1='0' y1='0' x2='0' y2='1'>
        <stop offset='0%' stop-color='#312e81'/>
        <stop offset='100%' stop-color='#0f172a'/>
      </linearGradient>
      <linearGradient id='gum' x1='0' y1='0' x2='0' y2='1'>
        <stop offset='0%' stop-color='#fda4af'/>
        <stop offset='100%' stop-color='#7f1d1d'/>
      </linearGradient>
    </defs>
    <rect x='4' y='6' width='152' height='42' rx='14' fill='url(#pitBody)' stroke='#1e1b4b' stroke-width='3'/>
    <path d='M10 18 Q80 0 150 18' fill='url(#gum)' stroke='#ef4444' stroke-width='2'/>
    <g fill='#fef9c3' stroke='#7f1d1d' stroke-width='2'>
      <path d='M16 20 L24 34 L8 34 Z'/>
      <path d='M36 20 L44 34 L28 34 Z'/>
      <path d='M56 20 L64 34 L48 34 Z'/>
      <path d='M76 20 L84 34 L68 34 Z'/>
      <path d='M96 20 L104 34 L88 34 Z'/>
      <path d='M116 20 L124 34 L108 34 Z'/>
      <path d='M136 20 L144 34 L128 34 Z'/>
    </g>
  </svg>`);
  Spr.bucketClosed = svgToImg(`<svg xmlns='http://www.w3.org/2000/svg' width='160' height='54' viewBox='0 0 160 54'>
    <defs>
      <linearGradient id='pitBodyShut' x1='0' y1='0' x2='0' y2='1'>
        <stop offset='0%' stop-color='#1e1b4b'/>
        <stop offset='100%' stop-color='#0b0a1f'/>
      </linearGradient>
      <linearGradient id='jaw' x1='0' y1='0' x2='0' y2='1'>
        <stop offset='0%' stop-color='#facc15'/>
        <stop offset='100%' stop-color='#b45309'/>
      </linearGradient>
    </defs>
    <rect x='4' y='10' width='152' height='38' rx='12' fill='url(#pitBodyShut)' stroke='#111827' stroke-width='3'/>
    <g fill='url(#jaw)' stroke='#78350f' stroke-width='2'>
      <path d='M10 30 L22 18 L6 18 Z'/>
      <path d='M30 30 L42 18 L26 18 Z'/>
      <path d='M50 30 L62 18 L46 18 Z'/>
      <path d='M70 30 L82 18 L66 18 Z'/>
      <path d='M90 30 L102 18 L86 18 Z'/>
      <path d='M110 30 L122 18 L106 18 Z'/>
      <path d='M130 30 L142 18 L126 18 Z'/>
    </g>
  </svg>`);
  // Power glyphs
  Spr.powerNone = svgToImg(`<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 64 64'><defs><radialGradient id='pn' cx='50%' cy='50%' r='45%'><stop offset='0%' stop-color='#312e81'/><stop offset='100%' stop-color='#111827'/></radialGradient></defs><circle cx='32' cy='32' r='28' fill='url(#pn)' stroke='#4338ca' stroke-width='2'/><line x1='18' y1='18' x2='46' y2='46' stroke='#a5b4fc' stroke-width='4' stroke-linecap='round' opacity='.6'/><line x1='46' y1='18' x2='18' y2='46' stroke='#a5b4fc' stroke-width='4' stroke-linecap='round' opacity='.6'/></svg>`);
  Spr.powerReaper = svgToImg(`<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 64 64'><defs><radialGradient id='pr' cx='50%' cy='50%' r='48%'><stop offset='0%' stop-color='#fca5a5'/><stop offset='100%' stop-color='#7f1d1d'/></radialGradient><linearGradient id='prb' x1='0' y1='0' x2='1' y2='1'><stop offset='0%' stop-color='#fde68a'/><stop offset='100%' stop-color='#fb923c'/></linearGradient></defs><circle cx='32' cy='32' r='28' fill='url(#pr)' stroke='#b91c1c' stroke-width='2'/><path d='M16 40 Q34 20 50 26' fill='none' stroke='url(#prb)' stroke-width='6' stroke-linecap='round'/><path d='M16 40 Q28 30 36 26' fill='rgba(15,23,42,.4)'/></svg>`);
  Spr.powerBlight = svgToImg(`<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 64 64'><defs><radialGradient id='pb' cx='50%' cy='45%' r='48%'><stop offset='0%' stop-color='#bbf7d0'/><stop offset='100%' stop-color='#14532d'/></radialGradient></defs><circle cx='32' cy='32' r='28' fill='url(#pb)' stroke='#065f46' stroke-width='2'/><path d='M18 42 C24 28 30 24 46 20 C40 30 36 36 32 48 Z' fill='rgba(22,163,74,.45)' stroke='#22c55e' stroke-width='2'/><circle cx='26' cy='22' r='4' fill='#ecfccb' opacity='.75'/><circle cx='40' cy='30' r='3' fill='#ecfccb' opacity='.6'/></svg>`);

  // ===== Game State =====
  const STATE = { BOOT:0, MENU:1, PLAY:2, GAMEOVER:3 };
  let state = STATE.BOOT; let bootProg=0; let bootMsgIdx=0;
  const bootMsgs = ["Feeding the beasts‚Ä¶","Harvesting eyes‚Ä¶","Summoning shadows‚Ä¶","Greasing the gears‚Ä¶","Salting the ground‚Ä¶"];

  const POW = { NONE:'none', REAPER:'reaper', BLIGHT:'blight' };
  const POWER_DATA = {
    none: {
      name: 'No Relic',
      desc: 'Break cursed pegs to uncover relics.',
      icon: 'powerNone',
    },
    reaper: {
      name: 'Reaper Fang',
      desc: 'Pierces up to 4 pegs and cleaves nearby cursed ones.',
      icon: 'powerReaper',
      charges: 4,
    },
    blight: {
      name: 'Ghoul Ichor',
      desc: 'Corrupts nearby pegs that melt moments later.',
      icon: 'powerBlight',
    },
  };

  function powerInfo(type){ return POWER_DATA[type] || POWER_DATA.none; }

  const world = {
    gravity: 0.34,
    friction: 0.995,
    ballsLeft: 10,
    score: 0,
    streak: 0,
    level: 1,
    ball: null,
    ballType: POW.NONE,
    pierce: 0,
    pegs: [],
    pendingHits: [],
    hallucinations: [],
    decals: [],
    particles: [],
    bucket: { x: W*0.25, y: H-50, w: 150, h: 46, vx: 2.2, open: true, anim:0 },
    aim: { x: W/2, y: 60, ang: -Math.PI/2, power: 14, ready: false },
    clearedCursed: 0,
    totalCursed: 0,
    screenShake: 0,
    fear: 0,
  };

  // ===== Level helpers =====
  function makeGrid(rows, cols, offsetY=140, jitter=10, curseEvery=5){
    const arr=[]; const gapX=W/(cols+1), gapY=52;
    for(let r=0;r<rows;r++) for(let c=0;c<cols;c++){
      const x = gapX*(c+1) + (Math.random()*2-1)*jitter + (r%2?gapX/2:0);
      const y = offsetY + r*gapY + (Math.random()*2-1)*jitter;
      const cursed = ((r*cols+c)%curseEvery===0);
      arr.push({x,y,r:20,type: cursed? 'cursed':'normal', hit:false, t:Math.random()*100});
    }
    return arr;
  }
  function ring(cx,cy,rad,count,type='normal'){ const arr=[]; for(let i=0;i<count;i++){ const a=i/count*Math.PI*2; arr.push({x:cx+Math.cos(a)*rad,y:cy+Math.sin(a)*rad,r:20,type,hit:false,t:Math.random()*100}); } return arr; }
  function spiral(cx, cy, turns=10, step=22, count=90){ const arr=[]; let t=0; for(let i=0;i<count;i++){ const r= t*step; const a = t * 0.55; arr.push({x:cx+Math.cos(a)*r, y:cy+Math.sin(a)*r, r:18, type: (i%7===0? 'cursed':'normal'), hit:false,t:Math.random()*100}); t += turns/count; } return arr; }
  function mix(arr, nSteel=10){ for(let i=0;i<nSteel && i<arr.length;i++) arr[i].type='steel'; return arr; }

  const LEVELS = [
    () => makeGrid(5,9,140,8,6),
    () => [...makeGrid(6,10,120,6,5), ...ring(W/2, H/2, 160, 18, 'cursed')],
    () => mix(makeGrid(7,11,110,5,4), 12),
    () => spiral(W/2, H/2, 12, 20, 88),
  ];

  function loadLevel(i){
    world.level = i; world.pegs = LEVELS[(i-1)%LEVELS.length]();
    world.totalCursed = world.pegs.filter(p=>p.type==='cursed').length;
    world.clearedCursed = 0; world.ball=null; world.aim.ready=true; world.ballsLeft = Math.max(6, 12 - i);
    world.streak=0; world.fear = Math.max(0, world.fear-10); world.ballType=POW.NONE; world.pierce=0; world.pendingHits=[]; world.hallucinations=[]; world.decals=[]; world.particles=[];
    world.bucket.w = 150;
    world.bucket.h = 46;
    world.bucket.y = H-50;
    sting(); updateHUD();
  }

  // ===== Entities =====
  class Ball{
    constructor(x,y,vx,vy){ this.x=x; this.y=y; this.vx=vx; this.vy=vy; this.r=14; this.dead=false; this.groundTime=0; }
    step(){
      this.vy += world.gravity;
      this.vx *= world.friction;
      this.vy *= world.friction;
      this.x += this.vx;
      this.y += this.vy;
      if(this.x < this.r){ this.x=this.r; this.vx*=-1; }
      if(this.x > W-this.r){ this.x=W-this.r; this.vx*=-1; }
      if(this.y < this.r){ this.y=this.r; this.vy*=-1; }
      if(this.y > H-this.r){
        this.y = H-this.r;
        if(this.vy > 0){
          this.groundTime++;
          if(this.groundTime > 120){ this.dead = true; }
        } else {
          this.groundTime = 0;
        }
        this.vy *= -0.55;
        this.vx *= 0.96;
        if(Math.abs(this.vy) < 1.2){ this.groundTime += 12; }
      } else {
        this.groundTime = 0;
      }
      this.collidePegs();
      this.collideBucket();
    }
    collidePegs(){
      for(const p of world.pegs){
        if(p.hit) continue;
        const dx=this.x-p.x, dy=this.y-p.y;
        const d=Math.hypot(dx,dy);
        if(d < this.r + p.r){
          const nx=dx/d, ny=dy/d;
          const vdot = this.vx*nx + this.vy*ny;
          if(world.ballType===POW.REAPER && world.pierce>0){
            world.pierce--;
            hitPeg(p,true,'ball');
            continue;
          }
          this.vx -= 2*vdot*nx;
          this.vy -= 2*vdot*ny;
          this.x = p.x + (this.r+p.r+0.2)*nx;
          this.y = p.y + (this.r+p.r+0.2)*ny;
          hitPeg(p,false,'ball');
        }
      }
    }
    collideBucket(){
      const b=world.bucket;
      if(this.y + this.r >= b.y && this.y - this.r <= b.y + b.h && this.x > b.x && this.x < b.x + b.w && this.vy>0){
        this.dead=true;
        world.ballsLeft++;
        world.streak+=3;
        world.score += 300 * (1 + Math.min(10, world.streak*0.2));
        screenShake(10);
        tone(880,0.08,'triangle',0.05);
        b.open=false; b.anim=12;
      }
    }
    draw(){
      let img = Spr.ball;
      if(world.ballType===POW.REAPER) img = Spr.reaperBall;
      else if(world.ballType===POW.BLIGHT) img = Spr.blightBall;
      ctx.drawImage(img, this.x-20, this.y-20, 40, 40);
    }
  }

  class Particle{ constructor(x,y,vx,vy,life,scale){ this.x=x; this.y=y; this.vx=vx; this.vy=vy; this.life=life; this.scale=scale||1; } step(){ this.vy += 0.18; this.x += this.vx; this.y += this.vy; this.vx *= 0.99; this.vy *= 0.99; this.life--; } draw(){ ctx.globalAlpha = Math.max(0, this.life/60); const s=32*this.scale; ctx.drawImage(Spr.splat, this.x-s/2, this.y-s/2, s, s); ctx.globalAlpha=1; } }

  // ===== Utilities =====
  function rect(x,y,w,h,fill){ ctx.fillStyle=fill; ctx.fillRect(x,y,w,h); }
  function screenShake(a){ if(!fxSettings.shake) return; world.screenShake = Math.max(world.screenShake, a); }
  function addDecal(x,y){ world.decals.push({x,y, s: (24+Math.random()*36)*quality.mul, rot: Math.random()*Math.PI}); if(world.decals.length>Math.floor(240*quality.mul)) world.decals.shift(); }

  // ===== Effects & Hits =====
  function grantPower(type, px, py){
    const info = powerInfo(type);
    world.ballType = type;
    if(type===POW.REAPER){
      world.pierce = info.charges || 4;
    }
    if(type===POW.BLIGHT){
      world.pendingHits = world.pendingHits.filter(job=>{
        if(job.source==='blight'){
          if(job.peg) delete job.peg.pending;
          return false;
        }
        return true;
      });
    }
    screenShake(8);
    tone(620,0.08,'triangle',0.04);
    showFloat(info.name, px, py);
    updateHUD();
  }

  function dropPowerupChance(px, py){
    if(Math.random()<0.22){
      const options = [POW.REAPER, POW.BLIGHT];
      const type = options[Math.floor(Math.random()*options.length)];
      grantPower(type, px, py);
    }
  }

  function hitPeg(p, pierce=false, source='ball'){
    if(!p || p.hit) return;
    const byBall = source === 'ball';
    const byBlight = source === 'blight';

    if(p.pending) delete p.pending;

    if(p.type==='steel'){
      if(byBlight){
        p.type='normal';
        delete p.pending;
        addDecal(p.x, p.y);
        noise(80,.15);
        screenShake(4);
        showFloat('Steel Melted', p.x, p.y-32);
      } else if(byBall){
        noise(90,.18);
        screenShake(3);
        world.streak = 0;
        world.score += 5;
      }
      return;
    }

    p.hit = true;
    const baseScore = byBall ? 60 : 45;
    if(byBall){
      world.streak++;
      world.score += baseScore + world.streak*12;
      showStreakPopup(world.streak, p.x, Math.max(50, p.y-26));
      noise(120,.22);
      screenShake(6);
    } else {
      world.score += baseScore;
      noise(95,.18);
      screenShake(4);
    }

    const intensity = byBall ? 1 : 0.65;
    world.fear = Math.min(100, world.fear + (byBall ? 1 + Math.random()*1.6 : 0.6 + Math.random()*0.4));
    const k = Math.floor(18*quality.mul*intensity);
    for(let i=0;i<k;i++){
      world.particles.push(new Particle(p.x, p.y, (Math.random()*2-1)*4.6*intensity, (Math.random()*2-1)*4.2*intensity, 36+Math.random()*30, .6+Math.random()*0.8));
    }
    for(let i=0;i<Math.floor(4*quality.mul*intensity);i++) addDecal(p.x+(Math.random()*2-1)*16, p.y+(Math.random()*2-1)*16);

    if(p.type==='cursed'){
      world.clearedCursed++;
      if(byBall){
        tone(240,0.08,'sawtooth',0.05);
        dropPowerupChance(p.x,p.y);
        if(world.fear>60 && Math.random()<0.35) whisper();
        if(world.fear>70){ subBoom(); }
      }
    }

    if(byBall){
      if(world.ballType===POW.REAPER){
        if(p.type==='cursed'){ spectralCleave(p); }
        if(!pierce && world.pierce<=0){ world.ballType = POW.NONE; updateHUD(); }
      } else if(world.ballType===POW.BLIGHT){
        spreadBlight(p);
      }
    }

    if(!byBall){
      updateHUD();
    }
  }

  function queuePegHit(peg, delay, source){
    if(!peg || peg.hit || peg.pending) return;
    peg.pending = source;
    world.pendingHits.push({ peg, timer: delay, source });
  }

  function processPendingHits(){
    let changed = false;
    for(let i=world.pendingHits.length-1; i>=0; i--){
      const job = world.pendingHits[i];
      if(!job || !job.peg){
        world.pendingHits.splice(i,1);
        continue;
      }
      if(job.peg.hit){
        delete job.peg.pending;
        world.pendingHits.splice(i,1);
        continue;
      }
      job.timer -= 1;
      if(job.timer <= 0){
        const peg = job.peg;
        delete peg.pending;
        hitPeg(peg,false, job.source || 'specter');
        world.pendingHits.splice(i,1);
        changed = true;
      }
    }
    if(changed){
      updateHUD();
    }
  }

  function spectralCleave(origin){
    const targets = world.pegs
      .filter(p=>p!==origin && !p.hit && p.type!=='steel' && !p.pending)
      .sort((a,b)=>Math.hypot(a.x-origin.x,a.y-origin.y) - Math.hypot(b.x-origin.x,b.y-origin.y));
    const count = Math.min(2, targets.length);
    for(let i=0;i<count;i++){
      const t = targets[i];
      queuePegHit(t, 14 + i*6, 'specter');
    }
  }

  function spreadBlight(origin){
    const targets = world.pegs
      .filter(p=>p!==origin && !p.hit && !p.pending)
      .sort((a,b)=>Math.hypot(a.x-origin.x,a.y-origin.y) - Math.hypot(b.x-origin.x,b.y-origin.y));
    const count = Math.min(3, targets.length);
    for(let i=0;i<count;i++){
      const t = targets[i];
      queuePegHit(t, 36 + Math.random()*28, 'blight');
    }
  }

  function showFloat(text,x,y){ const div=document.createElement('div'); div.textContent=text; div.style.cssText='position:absolute;left:'+x+'px;top:'+y+'px;transform:translate(-50%,-50%);font-weight:700;color:#ff6; text-shadow:0 0 8px #a00;'; ui.appendChild(div); let t=0; const id=setInterval(()=>{ t++; div.style.top=(y- t*1.2)+'px'; div.style.opacity = 1 - t/60; if(t>60){ clearInterval(id); div.remove(); }}, 16); }
  function showStreakPopup(count,x,y){ const div=document.createElement('div'); div.className='streak-pop'; div.textContent=count; div.style.left=x+'px'; div.style.top=y+'px'; div.style.transform='translate(-50%,-50%)'; ui.appendChild(div); let t=0; const id=setInterval(()=>{ t++; div.style.transform=`translate(-50%,-50%) translateY(${-(t*1.4)}px)`; const alpha=Math.max(0,1-t/24); div.style.opacity=alpha; if(t>=24){ clearInterval(id); div.remove(); }},16); }

  // ===== Input =====
  const mouse = {x: W/2, y: 60, down:false};
  canvas.addEventListener('mousemove', e=>{ const r=canvas.getBoundingClientRect(); mouse.x = e.clientX-r.left; mouse.y = e.clientY-r.top; const dx = mouse.x - W/2, dy = mouse.y - 60; world.aim.ang = Math.atan2(dy,dx); world.aim.power = Math.min(20, Math.hypot(dx,dy)/30 + 8); });
  canvas.addEventListener('mousedown', ()=>{ mouse.down=true; if(state===STATE.PLAY) fire(); else if(state===STATE.MENU) startGame(); else if(state===STATE.BOOT) bootProg=100; });
  window.addEventListener('mouseup', ()=> mouse.down=false);
  window.addEventListener('keydown', (e)=>{ if(e.code==='Space'){ if(state===STATE.MENU) startGame(); else if(state===STATE.PLAY) fire(); else if(state===STATE.BOOT) bootProg=100; } });

  function fire(){ if(!world.aim.ready || world.ballsLeft<=0) return; const a = world.aim.ang; const p = world.aim.power; world.ball = new Ball(W/2, 60, Math.cos(a)*p, Math.sin(a)*p); world.ballsLeft--; world.aim.ready=false; tone(520,0.06,'square',0.045); updateHUD(); }

  // ===== Bucket =====
  function stepBucket(){ const b=world.bucket; b.x += b.vx; if(b.x<20||b.x+b.w>W-20){ b.vx*=-1; } if(b.anim>0){ b.anim--; if(b.anim<=0){ b.open=true; } } }
  function drawBucket(){ const b=world.bucket; const spr = b.open? Spr.bucketOpen : Spr.bucketClosed; ctx.drawImage(spr, b.x, b.y, b.w, b.h); }

  // ===== UI Screens =====
  function setOverlay(html){ ui.innerHTML = html||''; }
  function showBoot(){ setOverlay(`<div class="menu"><div class="title">Evil Peggle</div><div class="subtitle" id="bootMsg">${bootMsgs[0]}</div><div class="meter" style="width:320px"><i id="bootFill" style="transform:scaleX(0)"></i></div><div class="warn">Content warning: flashing lights and stylized gore. Headphones recommended.</div><div class="flash" style="margin-top:10px">PRESS SPACE</div></div>`); }
  function tickBoot(){ bootProg = Math.min(100, bootProg + 1.5 + Math.random()*1.5); const fill=document.getElementById('bootFill'); const msg=document.getElementById('bootMsg'); if(fill) fill.style.transform = `scaleX(${bootProg/100})`; if(msg && bootProg>bootMsgIdx*20){ bootMsgIdx=(bootMsgIdx+1)%bootMsgs.length; msg.textContent = bootMsgs[bootMsgIdx]; } if(bootProg>=100){ startMenu(); } }
  function startMenu(){ state=STATE.MENU; world.aim.ready=false; setOverlay(`<div class="menu"><div class="title">Evil Peggle</div><div class="subtitle">H‚çúrr‚çúr Arcade</div><button class="btn play good" id="playBtn">‚ñ∂ PLAY</button><div class="warn">SPACE or Click to begin. Use the Quality menu if performance dips.</div><div class="flash">PRESS SPACE</div></div>`); document.getElementById('playBtn').onclick=()=> startGame(); }
  function startGame(){ state=STATE.PLAY; setOverlay(''); loadLevel(1); updateHUD(); world.aim.ready=true; }
  function showGameOver(){ const final = Math.floor(world.score); setOverlay(`<div class="menu"><div class="title">You Were Devoured</div><div class="subtitle">Final score: <b>${final}</b> ‚Äî Level ${world.level}</div><div class="row" style="gap:8px"><button class="btn good" id="retryBtn">‚Ü∫ Try Again</button><button class="btn" id="menuBtn">‚ò∞ Menu</button></div></div>`); document.getElementById('retryBtn').onclick=()=>{ setOverlay(''); state=STATE.PLAY; world.score=0; world.level=1; loadLevel(1); updateHUD(); }; document.getElementById('menuBtn').onclick=()=> startMenu(); }

  // ===== Draw helpers =====
  function drawBG(){ ctx.drawImage(Spr.bg, 0, 0, W, H); // flicker light
    const flick = 0.06 + Math.sin(Date.now()*0.002)*0.02; ctx.save(); ctx.globalAlpha=flick; const grd=ctx.createRadialGradient(W/2, 40, 40, W/2, 40, 420); grd.addColorStop(0,'rgba(255,60,80,.35)'); grd.addColorStop(1,'rgba(0,0,0,0)'); rect(0,0,W,H,grd); ctx.restore(); }
  function drawDecals(){ for(const d of world.decals){ ctx.save(); ctx.globalAlpha=.8; ctx.translate(d.x, d.y); ctx.rotate(d.rot); ctx.drawImage(Spr.splat, -d.s/2, -d.s/2, d.s, d.s); ctx.restore(); } }
  function drawPegs(){
    const t=Date.now()*0.008;
    for(const p of world.pegs){
      if(p.hit) continue;
      if(p.pending){
        const pulse = 0.45 + Math.sin(t*3 + p.t)*0.25;
        const radius = p.pending==='blight'? 36 : 32;
        const grd = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, radius);
        if(p.pending==='blight'){
          grd.addColorStop(0,'rgba(34,197,94,'+(0.35+pulse*0.25)+')');
          grd.addColorStop(1,'rgba(34,197,94,0)');
        } else {
          grd.addColorStop(0,'rgba(192,132,252,'+(0.4+pulse*0.3)+')');
          grd.addColorStop(1,'rgba(192,132,252,0)');
        }
        ctx.fillStyle = grd;
        ctx.beginPath();
        ctx.arc(p.x, p.y, radius, 0, Math.PI*2);
        ctx.fill();
      }
      const wob = Math.sin(p.t + t)* (p.type==='cursed'? 1.8:0.9);
      const img = p.type==='cursed'
        ? (Math.sin(t*3+p.t)>0? Spr.cursedA: Spr.cursedB)
        : (p.type==='steel'? Spr.steel : Spr.meat);
      ctx.drawImage(img, p.x-22+wob, p.y-22, 44, 44);
    }
  }
  function drawHallucinations(){ if(world.fear<60 || !fxSettings.visions) return; const count = Math.min(10, Math.floor((world.fear-60)/4)); // generate positions if needed
    while(world.hallucinations.length<count){ world.hallucinations.push({x:Math.random()*W, y:120+Math.random()*(H-220), r:20, t:Math.random()*100}); }
    ctx.save(); ctx.globalAlpha = 0.28 + Math.random()*0.12; for(const h of world.hallucinations){ const wob=Math.sin(h.t + Date.now()*0.008)*1.2; ctx.drawImage(Spr.cursedA, h.x-22+wob, h.y-22, 44, 44); } ctx.restore(); }
  function drawAimer(){ if(!world.aim.ready) return; const a=world.aim.ang; const p=world.aim.power; const tx=W/2+Math.cos(a)*p*5, ty=60+Math.sin(a)*p*5; ctx.save(); if(world.fear>70){ ctx.filter='contrast(140%) saturate(120%) blur(1px)'; } ctx.globalAlpha=.9; ctx.setLineDash([6,6]); ctx.lineDashOffset = - (Date.now()*0.05 % 12); ctx.beginPath(); ctx.moveTo(W/2, 60); ctx.lineTo(tx, ty); ctx.strokeStyle='#f43f5e'; ctx.lineWidth=2; ctx.stroke(); ctx.setLineDash([]); ctx.restore(); }

  function updateHUD(){
    ballsLabel.textContent = world.ballsLeft;
    scoreLabel.textContent = Math.floor(world.score);
    levelLabel.textContent = world.level;
    fearLabel.textContent = Math.round(world.fear)+'%';
    if(fearFill){
      const scale = Math.max(0, Math.min(1, world.fear/100));
      fearFill.style.transform = `scaleX(${scale})`;
    }
    const prog = world.totalCursed? world.clearedCursed/world.totalCursed : 0;
    progressFill.style.transform = `scaleX(${prog})`;

    const info = powerInfo(world.ballType);
    if(powerName){ powerName.textContent = info.name; }
    if(powerDesc){
      if(world.ballType===POW.REAPER){
        powerDesc.textContent = `Pierce charges left: ${Math.max(0, world.pierce)} ‚Äî cleaves cursed.`;
      } else if(world.ballType===POW.BLIGHT){
        const queued = world.pendingHits.filter(h=>h.source==='blight').length;
        powerDesc.textContent = queued? `Corrupting ${queued} pegs. Impact spreads rot.` : info.desc;
      } else {
        powerDesc.textContent = info.desc;
      }
    }
    if(powerIcon){
      const iconSprite = Spr[info.icon];
      powerIcon.src = iconSprite ? iconSprite.src : '';
      powerIcon.style.opacity = iconSprite ? '1' : '0.2';
    }
    powerSlot?.classList.toggle('power-empty', world.ballType===POW.NONE);
  }

  function checkEnd(){ if(world.clearedCursed >= world.totalCursed){ sting(); const k = Math.floor(220*quality.mul); for(let i=0;i<k;i++) world.particles.push(new Particle(W/2, H-120, (Math.random()*2-1)*6, -Math.random()*5-2, 60+Math.random()*40, .8+Math.random()*0.8)); world.score += 1200 + world.ballsLeft*140; world.level++; loadLevel(world.level); } else if(world.ball?.dead){ world.ball=null; world.aim.ready=true; world.streak=0; if(world.ballsLeft<=0){ state=STATE.GAMEOVER; showGameOver(); } } }

  function withShake(draw){ if(world.screenShake>0){ world.screenShake*=0.9; const s=world.screenShake; const dx=(Math.random()*2-1)*s, dy=(Math.random()*2-1)*s; ctx.save(); ctx.translate(dx,dy); draw(); ctx.restore(); } else draw(); }

  // ===== Loop =====
  function loop(){ requestAnimationFrame(loop);
    if(state===STATE.BOOT){ drawBG(); tickBoot(); return; }
    if(state===STATE.MENU){ drawBG(); return; }
    if(state===STATE.PLAY && world.pendingHits.length){ processPendingHits(); }
    withShake(()=>{ if(world.fear>70) ctx.filter='contrast(140%) saturate(115%) blur(1px)'; drawBG(); ctx.filter='none'; drawHallucinations(); drawDecals(); stepBucket(); drawBucket(); drawPegs(); world.ball?.step(); for(let i=world.particles.length-1;i>=0;i--){ const pt=world.particles[i]; pt.step(); pt.draw(); if(pt.life<=0 || pt.y>H+60) world.particles.splice(i,1); } world.ball?.draw(); drawAimer(); });
    if(state===STATE.PLAY){ if(world.fear>0) world.fear = Math.max(0, world.fear - 0.01); }
    checkEnd(); updateHUD();
  }

  // ===== Reset/Button actions =====
  resetBtn.onclick = ()=>{ if(state===STATE.PLAY){ loadLevel(world.level);} else if(state===STATE.GAMEOVER){ startMenu(); } };

  // ===== Boot & start =====
  showBoot();
  setInterval(()=>{ if(state===STATE.BOOT) tickBoot(); }, 40);
  loop();
})();
</script>
</body>
</html>
